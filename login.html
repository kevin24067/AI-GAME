<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户登录 - 游戏大厅</title>
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <h1>游戏大厅登录</h1>
            
            <div class="auth-tabs">
                <button class="tab-btn active" onclick="showLogin()">登录</button>
                <button class="tab-btn" onclick="showRegister()">注册</button>
            </div>
            
            <!-- 登录表单 -->
            <div id="login-form" class="auth-form">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-email">邮箱</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">密码</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="auth-btn">登录</button>
                </form>
            </div>
            
            <!-- 注册表单 -->
            <div id="register-form" class="auth-form" style="display: none;">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="register-email">邮箱</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">密码</label>
                        <input type="password" id="register-password" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">确认密码</label>
                        <input type="password" id="confirm-password" required minlength="6">
                    </div>
                    <button type="submit" class="auth-btn">注册</button>
                </form>
            </div>
            
            <div class="message" id="message"></div>
            
            <div class="back-link">
                <a href="index.html">返回游戏大厅</a>
            </div>
        </div>
    </div>

    <!-- 从 CDN 加载 Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/page-analytics.js"></script>
    <script>
        // 页面加载时初始化 Supabase
        document.addEventListener('DOMContentLoaded', function() {
            // 确保 Supabase CDN 已加载
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase CDN 未加载，请检查网络连接');
                showMessage('Supabase 加载失败，请刷新页面重试', 'error');
                return;
            }
            
            // 直接创建 Supabase 客户端
            try {
                window.supabase = window.supabase.createClient(
                    'https://wdevawgwxnxqdgkxnegd.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkZXZhd2d3eG54cWRna3huZWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDIwODAsImV4cCI6MjA3MDg3ODA4MH0.U_f453KdjSdELparSVe7YKgyLr2R2oLBwdluPFxVjAs',
                    {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true
                        }
                    }
                );
                console.log('✅ Supabase 客户端直接初始化成功');
                
                // 检查用户是否已登录
                checkAuthStatus();
            } catch (error) {
                console.error('❌ Supabase 直接初始化失败:', error);
                showMessage('Supabase 初始化失败，请刷新页面重试', 'error');
            }
        });

        // 检查认证状态
        async function checkAuthStatus() {
            try {
                const { data: { user }, error } = await window.supabase.auth.getUser();
                if (error) {
                    console.warn('获取用户信息失败:', error.message);
                    return;
                }
                
                if (user) {
                    showMessage(`欢迎回来，${user.email}！`, 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('检查认证状态失败:', error);
            }
        }

        // 切换到登录表单
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        }

        // 切换到注册表单
        function showRegister() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        }

        // 处理登录
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            showMessage('正在登录...', 'info');
            
            try {
                const { data, error } = await window.supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) {
                    showMessage(`登录失败: ${error.message}`, 'error');
                    console.error('登录失败:', error);
                    return;
                }
                
                showMessage('登录成功！正在跳转...', 'success');
                console.log('登录成功，用户信息:', data);
                
                // 确保认证状态已更新后再跳转
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                showMessage(`登录失败: ${error.message}`, 'error');
                console.error('登录过程中出错:', error);
            }
        }

        // 处理注册
        async function handleRegister(event) {
            event.preventDefault();
            
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (password !== confirmPassword) {
                showMessage('密码确认不匹配', 'error');
                return;
            }
            
            showMessage('正在注册...', 'info');
            
            try {
                const { data, error } = await window.supabase.auth.signUp({
                    email: email,
                    password: password,
                });
                
                if (error) {
                    showMessage(`注册失败: ${error.message}`, 'error');
                    console.error('注册失败:', error);
                    return;
                }
                
                showMessage('注册成功！请检查邮箱验证链接。', 'success');
                console.log('注册成功:', data);
                
                // 切换到登录表单
                setTimeout(() => {
                    showLogin();
                }, 3000);
            } catch (error) {
                showMessage(`注册失败: ${error.message}`, 'error');
                console.error('注册过程中出错:', error);
            }
        }

        // 显示消息
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>