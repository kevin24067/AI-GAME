<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏大厅</title>
    <link rel="stylesheet" href="css/lobby.css">
</head>
<body>
    <!-- 从 CDN 加载 Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/page-analytics.js"></script>
    
    <div class="lobby-container">
        <header>
            <h1>游戏大厅</h1>
            <p>选择一个游戏开始玩吧！</p>
            <div class="auth-section">
                <a href="login.html" class="login-btn" id="login-link">登录/注册</a>
                <span id="user-info" style="display: none;">
                    欢迎，<span id="user-email"></span>
                    <button onclick="handleLogout()" class="logout-btn">登出</button>
                </span>
            </div>
        </header>
        
        <div class="games-grid">
            <div class="game-card" id="mario-card">
                <div class="game-icon">
                    <div class="placeholder-icon mario-icon">M</div>
                </div>
                <div class="game-info">
                    <h2>超级马里奥</h2>
                    <p>经典平台跳跃游戏，收集金币，踩扁敌人！</p>
                    <a href="games/mario/index.html" class="play-button">开始游戏</a>
                </div>
            </div>
            
            <div class="game-card" id="chess-card">
                <div class="game-icon">
                    <div class="placeholder-icon chess-icon">象</div>
                </div>
                <div class="game-info">
                    <h2>中国象棋</h2>
                    <p>传统中国象棋游戏，体验古老的战略棋盘游戏！</p>
                    <a href="games/chess/index.html" class="play-button">开始游戏</a>
                </div>
            </div>
            
            <div class="game-card" id="math-card">
                <div class="game-icon">
                    <div class="placeholder-icon math-icon">算</div>
                </div>
                <div class="game-info">
                    <h2>算术小游戏</h2>
                    <p>面向小学生的算术练习，按年级设置难度，提高计算能力！</p>
                    <a href="games/math/index.html" class="play-button">开始游戏</a>
                </div>
            </div>
            
            <div class="game-card" id="notes-card">
                <div class="game-icon">
                    <div class="placeholder-icon notes-icon">笔</div>
                </div>
                <div class="game-info">
                    <h2>日常随笔</h2>
                    <p>记录你的日常想法、心得和有趣的发现，留下美好的回忆！</p>
                    <a href="notes/index.html" class="play-button">查看随笔</a>
                </div>
            </div>
            
            <div class="game-card" id="pharaoh-card">
                <div class="game-icon">
                    <div class="placeholder-icon pharaoh-icon">法</div>
                </div>
                <div class="game-info">
                    <h2>法老之光</h2>
                    <p>古埃及主题策略棋盘游戏，利用激光、镜子和特殊棋子，击中对方法老获胜！</p>
                    <a href="games/pharaoh/index.html" class="play-button">开始游戏</a>
                </div>
            </div>
            
            <!-- 隐藏官兵抓小偷游戏入口 -->
            <!-- <div class="game-card" id="thief-card">
                <div class="game-icon">
                    <div class="placeholder-icon thief-icon">偷</div>
                </div>
                <div class="game-info">
                    <h2>官兵抓小偷</h2>
                    <p>刺激的追逐游戏，控制小偷躲避官兵，收集金币并找到出口！</p>
                    <a href="games/thief/index.html" class="play-button">开始游戏</a>
                </div>
            </div> -->
            
            <!-- 隐藏单机双人跳棋游戏入口 -->
            <!-- <div class="game-card" id="checkers-card">
                <div class="game-icon">
                    <div class="placeholder-icon checkers-icon">跳</div>
                </div>
                <div class="game-info">
                    <h2>单机双人跳棋</h2>
                    <p>经典的双人跳棋游戏，轮流移动棋子，吃掉对方棋子或使对方无法移动获胜！</p>
                    <a href="games/checkers/index.html" class="play-button">开始游戏</a>
                </div>
            </div> -->
            
            <!-- 隐藏激光策略棋游戏入口 -->
            <!-- <div class="game-card" id="laser-card">
                <div class="game-icon">
                    <div class="placeholder-icon laser-icon">激</div>
                </div>
                <div class="game-info">
                    <h2>激光策略棋</h2>
                    <p>创新的策略棋盘游戏，利用镜子反射激光，击中对方的法老棋子获胜！</p>
                    <a href="games/laser/index.html" class="play-button">开始游戏</a>
                </div>
            </div> -->
        </div>
        
        <footer>
            <p>&copy; 2025 游戏大厅 - 所有游戏仅供娱乐 | <a href="admin/analytics.html" class="admin-link" style="color: inherit; text-decoration: none;">管理</a></p>
        </footer>
    </div>

    <script>
        // 页面加载时初始化 Supabase 并检查用户状态
        document.addEventListener('DOMContentLoaded', function() {
            // 确保 Supabase CDN 已加载
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase CDN 未加载，请检查网络连接');
                return;
            }
            
            // 直接创建 Supabase 客户端
            try {
                window.supabase = window.supabase.createClient(
                    'https://wdevawgwxnxqdgkxnegd.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkZXZhd2d3eG54cWRna3huZWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDIwODAsImV4cCI6MjA3MDg3ODA4MH0.U_f453KdjSdELparSVe7YKgyLr2R2oLBwdluPFxVjAs',
                    {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true
                        }
                    }
                );
                console.log('✅ Supabase 客户端直接初始化成功');
                
                // 检查用户状态
                checkAuthStatus();
                
                // 监听认证状态变化
                window.supabase.auth.onAuthStateChange((event, session) => {
                    console.log('认证状态变化:', event, session);
                    setTimeout(checkAuthStatus, 100);
                });
            } catch (error) {
                console.error('❌ Supabase 直接初始化失败:', error);
            }
        });

        // 检查认证状态
        async function checkAuthStatus() {
            try {
                const { data: { user }, error } = await window.supabase.auth.getUser();
                
                if (error) {
                    console.warn('获取用户信息失败:', error.message);
                    // 显示登录链接
                    document.getElementById('login-link').style.display = 'inline-block';
                    document.getElementById('user-info').style.display = 'none';
                    return;
                }
                
                console.log('当前用户:', user);
                
                if (user) {
                    // 显示用户信息
                    document.getElementById('login-link').style.display = 'none';
                    document.getElementById('user-info').style.display = 'inline-block';
                    document.getElementById('user-email').textContent = user.email;
                    console.log('用户已登录:', user.email);
                } else {
                    // 显示登录链接
                    document.getElementById('login-link').style.display = 'inline-block';
                    document.getElementById('user-info').style.display = 'none';
                    console.log('用户未登录');
                }
            } catch (error) {
                console.error('检查认证状态失败:', error);
                // 显示登录链接
                document.getElementById('login-link').style.display = 'inline-block';
                document.getElementById('user-info').style.display = 'none';
            }
        }

        // 处理登出
        async function handleLogout() {
            try {
                const { error } = await window.supabase.auth.signOut();
                
                if (error) {
                    console.error('登出失败:', error.message);
                    alert('登出失败: ' + error.message);
                    return;
                }
                
                console.log('登出成功');
                // 刷新页面状态
                checkAuthStatus();
                alert('已成功登出');
            } catch (error) {
                console.error('登出过程中出错:', error);
                alert('登出失败');
            }
        }

        // 手动刷新认证状态（调试用）
        function refreshAuth() {
            checkAuthStatus();
        }
    </script>
</body>
</html>
